<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrasi DKI Jakarta</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Scrollbar Halus */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Marker & Animation */
        .pulse-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.3); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
        }

        /* Accordion Transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.active {
            max-height: 1000px; /* Increased for filtering */
            opacity: 1;
        }
        
        /* Custom Tooltip Style (Label Kecamatan) */
        .kecamatan-label {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 9999px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-size: 10px !important;
            font-weight: 700 !important;
            color: #334155 !important;
            padding: 2px 8px !important;
            white-space: nowrap !important;
            transition: all 0.2s;
        }
        .kecamatan-label::before { display: none !important; }
        
        .kecamatan-label.highlighted {
            background-color: #f59e0b !important;
            color: white !important;
            border-color: #d97706 !important;
            transform: scale(1.1);
            z-index: 1000 !important;
        }

        /* Kelurahan Label inside Polygon */
        .kelurahan-tooltip {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: rgba(255, 255, 255, 0.9) !important; /* Agak transparan */
            font-weight: 600 !important; /* Sedikit lebih tipis dari bold biasa */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important; /* Shadow agar terbaca di background terang */
            font-size: 10px !important;
            text-align: center !important;
            opacity: 0.85; /* Keseluruhan elemen agak transparan */
            white-space: normal !important; /* Allow wrapping if text is long */
            width: 80px; /* Limit width to force wrap/centering */
        }

        /* Locate Control Custom Style */
        .leaflet-control-locate {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            width: 30px; 
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        .leaflet-control-locate:hover { background: #f4f4f4; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden text-gray-800 font-sans">

    <!-- Sidebar -->
    <div class="absolute top-4 left-4 z-[1000] w-80 flex flex-col max-h-[90vh] shadow-2xl rounded-xl overflow-hidden transition-transform duration-300" id="sidebar">
        <!-- Header & Search -->
        <div class="bg-slate-800 text-white p-4 pb-3">
            <h1 class="font-bold text-lg flex items-center mb-1">
                <i class="fa-solid fa-chart-pie text-amber-400 mr-2"></i> Dashboard Jakarta
            </h1>
            <p class="text-xs text-slate-300 mb-3">Data Wilayah & Statistik Kependudukan</p>
            
            <!-- Search Input -->
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Cari Kecamatan / Kelurahan..." 
                    class="w-full bg-slate-700 text-white text-sm rounded-lg pl-9 pr-3 py-2 border border-slate-600 focus:outline-none focus:border-amber-400 placeholder-slate-400 transition">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
            </div>
        </div>

        <!-- Navigation / Content -->
        <div class="glass-panel flex-1 overflow-y-auto custom-scroll p-2">
            <div id="city-list" class="space-y-2">
                <!-- City items generated by JS -->
            </div>
            <!-- Empty State for Search -->
            <div id="no-results" class="hidden p-8 text-center text-gray-400">
                <i class="fa-solid fa-map-location-dot text-3xl mb-2"></i>
                <p class="text-xs">Wilayah tidak ditemukan</p>
            </div>
        </div>

        <!-- Detail Panel (Bottom Fixed inside Sidebar) -->
        <div id="detail-panel" class="bg-white border-t border-gray-200 p-0 hidden transition-all duration-300">
            <!-- Title Bar -->
            <div class="bg-gray-50 p-3 flex justify-between items-center border-b border-gray-100">
                <div>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-blue-600" id="detail-parent">JAKARTA BARAT</span>
                    <h2 class="font-bold text-lg leading-none text-gray-800" id="detail-title">Cengkareng</h2>
                </div>
                <button onclick="closeDetail()" class="text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[40vh] custom-scroll">
                <!-- Stats Grid (Simulated Data) -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-blue-50 p-2 rounded border border-blue-100 text-center">
                        <p class="text-[10px] text-blue-500 font-bold uppercase">Populasi</p>
                        <p class="text-lg font-bold text-blue-800" id="stat-population">-</p>
                    </div>
                    <div class="bg-green-50 p-2 rounded border border-green-100 text-center">
                        <p class="text-[10px] text-green-500 font-bold uppercase">Luas (kmÂ²)</p>
                        <p class="text-lg font-bold text-green-800" id="stat-area">-</p>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mb-2 font-semibold flex items-center">
                    <i class="fa-solid fa-layer-group mr-1"></i> Daftar Kelurahan (Lihat Peta):
                </p>
                <div class="flex flex-wrap gap-1" id="detail-tags">
                    <!-- Tags here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Toggle -->
    <button onclick="toggleSidebar()" class="absolute bottom-6 left-4 z-[1000] bg-slate-800 text-white p-3 rounded-full shadow-lg md:hidden hover:bg-slate-700 transition transform hover:scale-105">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Map -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- 1. DATA STRUKTUR (LENGKAP 5 WILAYAH) ---
        const jakartaData = [
            {
                id: 'jakpus',
                name: 'Jakarta Pusat',
                color: '#ef4444', 
                center: [-6.1805, 106.8284],
                boundary: [[-6.145, 106.815], [-6.155, 106.870], [-6.200, 106.860], [-6.215, 106.805], [-6.170, 106.800]],
                districts: [
                    { name: 'Gambir', lat: -6.1767, lng: 106.8306, kels: ['Gambir', 'Kebon Kelapa', 'Petojo Selatan', 'Duri Pulo', 'Cideng', 'Petojo Utara'] },
                    { name: 'Tanah Abang', lat: -6.1887, lng: 106.8152, kels: ['Bendungan Hilir', 'Karet Tengsin', 'Kebon Melati', 'Kebon Kacang', 'Kampung Bali', 'Petamburan', 'Gelora'] },
                    { name: 'Menteng', lat: -6.1950, lng: 106.8320, kels: ['Menteng', 'Pegangsaan', 'Cikini', 'Kebon Sirih', 'Gondangdia'] },
                    { name: 'Senen', lat: -6.1880, lng: 106.8450, kels: ['Senen', 'Kwitang', 'Kenari', 'Paseban', 'Kramat', 'Bungur'] },
                    { name: 'Cempaka Putih', lat: -6.1800, lng: 106.8680, kels: ['Cempaka Putih Timur', 'Cempaka Putih Barat', 'Rawasari'] },
                    { name: 'Johar Baru', lat: -6.1850, lng: 106.8550, kels: ['Galur', 'Tanah Tinggi', 'Kampung Rawa', 'Johar Baru'] },
                    { name: 'Kemayoran', lat: -6.1600, lng: 106.8550, kels: ['Gunung Sahari Selatan', 'Kemayoran', 'Kebon Kosong', 'Harapan Mulya', 'Cempaka Baru', 'Utan Panjang', 'Sumur Batu', 'Serdang'] },
                    { name: 'Sawah Besar', lat: -6.1500, lng: 106.8300, kels: ['Pasar Baru', 'Gunung Sahari Utara', 'Mangga Dua Selatan', 'Karang Anyar', 'Kartini'] }
                ]
            },
            {
                id: 'jakut',
                name: 'Jakarta Utara',
                color: '#3b82f6', 
                center: [-6.1300, 106.8800],
                boundary: [[-6.090, 106.750], [-6.090, 106.970], [-6.170, 106.940], [-6.160, 106.860], [-6.130, 106.780]],
                districts: [
                    { name: 'Penjaringan', lat: -6.1200, lng: 106.7800, kels: ['Penjaringan', 'Pluit', 'Pejagalan', 'Kapuk Muara', 'Kamal Muara'] },
                    { name: 'Tanjung Priok', lat: -6.1300, lng: 106.8700, kels: ['Tanjung Priok', 'Kebon Bawang', 'Sungai Bambu', 'Papanggo', 'Warakas', 'Sunter Agung', 'Sunter Jaya'] },
                    { name: 'Koja', lat: -6.1250, lng: 106.9050, kels: ['Koja', 'Rawa Badak Utara', 'Rawa Badak Selatan', 'Tugu Utara', 'Tugu Selatan', 'Lagoa'] },
                    { name: 'Cilincing', lat: -6.1200, lng: 106.9400, kels: ['Kali Baru', 'Cilincing', 'Semper Barat', 'Semper Timur', 'Sukapura', 'Rorotan', 'Marunda'] },
                    { name: 'Pademangan', lat: -6.1350, lng: 106.8400, kels: ['Pademangan Timur', 'Pademangan Barat', 'Ancol'] },
                    { name: 'Kelapa Gading', lat: -6.1600, lng: 106.9000, kels: ['Kelapa Gading Barat', 'Kelapa Gading Timur', 'Pegangsaan Dua'] }
                ]
            },
            {
                id: 'jakbar',
                name: 'Jakarta Barat',
                color: '#f59e0b', 
                center: [-6.1600, 106.7500],
                boundary: [[-6.100, 106.690], [-6.130, 106.820], [-6.200, 106.820], [-6.230, 106.770], [-6.180, 106.690]],
                districts: [
                    { name: 'Cengkareng', lat: -6.1528, lng: 106.7431, kels: ['Cengkareng Barat', 'Cengkareng Timur', 'Duri Kosambi', 'Kapuk', 'Kedaung Kali Angke', 'Rawa Buaya'] },
                    { name: 'Grogol Petamburan', lat: -6.1687, lng: 106.7895, kels: ['Grogol', 'Jelambar Baru', 'Jelambar', 'Tanjung Duren Selatan', 'Tanjung Duren Utara', 'Tomang', 'Wijaya Kusuma'] },
                    { name: 'Taman Sari', lat: -6.1438, lng: 106.8188, kels: ['Glodok', 'Keagungan', 'Krukut', 'Mangga Besar', 'Maphar', 'Pinangsia', 'Taman Sari', 'Tangki'] },
                    { name: 'Tambora', lat: -6.1465, lng: 106.8045, kels: ['Angke', 'Duri Selatan', 'Duri Utara', 'Jembatan Besi', 'Jembatan Lima', 'Kali Anyar', 'Krendang', 'Pekojan', 'Roa Malaka', 'Tambora', 'Tanah Sereal'] },
                    { name: 'Kebon Jeruk', lat: -6.1912, lng: 106.7733, kels: ['Duri Kepa', 'Kebon Jeruk', 'Kedoya Selatan', 'Kedoya Utara', 'Kelapa Dua', 'Sukabumi Selatan', 'Sukabumi Utara'] },
                    { name: 'Kalideres', lat: -6.1464, lng: 106.7032, kels: ['Kalideres', 'Kamal', 'Pegadungan', 'Semanan', 'Tegal Alur'] },
                    { name: 'Palmerah', lat: -6.1923, lng: 106.7972, kels: ['Jatipulo', 'Kemanggisan', 'Kota Bambu Selatan', 'Kota Bambu Utara', 'Palmerah', 'Slipi'] },
                    { name: 'Kembangan', lat: -6.1918, lng: 106.7410, kels: ['Joglo', 'Kembangan Selatan', 'Kembangan Utara', 'Meruya Selatan', 'Meruya Utara', 'Srengseng'] }
                ]
            },
            {
                id: 'jaksel',
                name: 'Jakarta Selatan',
                color: '#10b981', 
                center: [-6.2600, 106.8100],
                boundary: [[-6.205, 106.770], [-6.205, 106.860], [-6.300, 106.850], [-6.350, 106.800], [-6.250, 106.750]],
                districts: [
                    { name: 'Kebayoran Baru', lat: -6.2380, lng: 106.8000, kels: ['Selong', 'Gunung', 'Kramat Pela', 'Gandaria Utara', 'Cipete Utara', 'Pulo', 'Melawai', 'Petogogan', 'Rawa Barat', 'Senayan'] },
                    { name: 'Kebayoran Lama', lat: -6.2450, lng: 106.7780, kels: ['Grogol Utara', 'Grogol Selatan', 'Cipulir', 'Kebayoran Lama Utara', 'Kebayoran Lama Selatan', 'Pondok Pinang'] },
                    { name: 'Pesanggrahan', lat: -6.2500, lng: 106.7600, kels: ['Ulujami', 'Petukangan Utara', 'Petukangan Selatan', 'Pesanggrahan', 'Bintaro'] },
                    { name: 'Cilandak', lat: -6.2900, lng: 106.8000, kels: ['Cipete Selatan', 'Gandaria Selatan', 'Cilandak Barat', 'Lebak Bulus', 'Pondok Labu'] },
                    { name: 'Pasar Minggu', lat: -6.2900, lng: 106.8400, kels: ['Pejaten Barat', 'Pejaten Timur', 'Pasar Minggu', 'Kebagusan', 'Jati Padang', 'Ragunan', 'Cilandak Timur'] },
                    { name: 'Jagakarsa', lat: -6.3300, lng: 106.8200, kels: ['Tanjung Barat', 'Lenteng Agung', 'Jagakarsa', 'Ciganjur', 'Srengseng Sawah', 'Cipedak'] },
                    { name: 'Mampang Prapatan', lat: -6.2500, lng: 106.8250, kels: ['Kuningan Barat', 'Pela Mampang', 'Bangka', 'Tegal Parang', 'Mampang Prapatan'] },
                    { name: 'Pancoran', lat: -6.2550, lng: 106.8500, kels: ['Kalibata', 'Rawa Jati', 'Duren Tiga', 'Cikoko', 'Pengadegan', 'Pancoran'] },
                    { name: 'Tebet', lat: -6.2300, lng: 106.8500, kels: ['Tebet Barat', 'Tebet Timur', 'Kebon Baru', 'Bukit Duri', 'Manggarai', 'Manggarai Selatan', 'Menteng Dalam'] },
                    { name: 'Setiabudi', lat: -6.2150, lng: 106.8280, kels: ['Setiabudi', 'Karet', 'Karet Semanggi', 'Karet Kuningan', 'Kuningan Timur', 'Menteng Atas', 'Pasar Manggis', 'Guntur'] }
                ]
            },
            {
                id: 'jaktim',
                name: 'Jakarta Timur',
                color: '#a855f7', 
                center: [-6.2200, 106.9000],
                boundary: [[-6.155, 106.880], [-6.155, 106.960], [-6.300, 106.920], [-6.370, 106.880], [-6.210, 106.850]],
                districts: [
                    { name: 'Matraman', lat: -6.2000, lng: 106.8600, kels: ['Pisangan Baru', 'Utan Kayu Selatan', 'Utan Kayu Utara', 'Kayu Manis', 'Pal Meriam', 'Kebon Manggis'] },
                    { name: 'Pulo Gadung', lat: -6.1950, lng: 106.8900, kels: ['Kayu Putih', 'Jati', 'Rawamangun', 'Pisangan Timur', 'Cipinang', 'Jatinegara Kaum', 'Pulo Gadung'] },
                    { name: 'Jatinegara', lat: -6.2250, lng: 106.8750, kels: ['Bali Mester', 'Kampung Melayu', 'Bidaracina', 'Cipinang Cempedak', 'Rawa Bunga', 'Cipinang Besar Utara', 'Cipinang Besar Selatan', 'Cipinang Muara'] },
                    { name: 'Duren Sawit', lat: -6.2300, lng: 106.9200, kels: ['Pondok Bambu', 'Duren Sawit', 'Pondok Kelapa', 'Pondok Kopi', 'Malaka Jaya', 'Malaka Sari', 'Klender'] },
                    { name: 'Kramat Jati', lat: -6.2700, lng: 106.8700, kels: ['Kramat Jati', 'Batu Ampar', 'Balekambang', 'Kampung Tengah', 'Dukuh', 'Cawang', 'Cililitan'] },
                    { name: 'Makasar', lat: -6.2700, lng: 106.8950, kels: ['Pinang Ranti', 'Makasar', 'Halim Perdana Kusuma', 'Cipinang Melayu', 'Kebon Pala'] },
                    { name: 'Pasar Rebo', lat: -6.3150, lng: 106.8600, kels: ['Pekayon', 'Gedong', 'Cijantung', 'Baru', 'Kalisari'] },
                    { name: 'Ciracas', lat: -6.3300, lng: 106.8750, kels: ['Cibubur', 'Kelapa Dua Wetan', 'Ciracas', 'Susukan', 'Rambutan'] },
                    { name: 'Cipayung', lat: -6.3200, lng: 106.9100, kels: ['Lubang Buaya', 'Ceger', 'Cipayung', 'Munjul', 'Pondok Ranggon', 'Cilangkap', 'Setu', 'Bambu Apus'] },
                    { name: 'Cakung', lat: -6.1900, lng: 106.9400, kels: ['Cakung', 'Cakung Timur', 'Rawa Terate', 'Jatinegara', 'Penggilingan', 'Pulo Gebang', 'Ujung Menteng'] }
                ]
            }
        ];

        // --- 2. INITIALIZE MAP ---
        const map = L.map('map', { 
            zoomControl: false 
        }).setView([-6.2088, 106.8456], 11);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'OpenStreetMap, CartoDB',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- 3. CUSTOM CONTROLS ---
        
        // "Locate Me" Control
        const LocateControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
                container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg"></i>';
                container.title = "Lokasi Saya";
                container.onclick = function() {
                    if (navigator.geolocation) {
                        container.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-lg"></i>';
                        navigator.geolocation.getCurrentPosition(position => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Remove previous location marker if any
                            if (window.userMarker) map.removeLayer(window.userMarker);
                            
                            window.userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: '<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg animate-bounce"></div>'
                                })
                            }).addTo(map).bindPopup("Lokasi Anda").openPopup();

                            map.flyTo([lat, lng], 15);
                            container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg text-blue-600"></i>';
                        }, () => {
                            alert("Gagal mendeteksi lokasi.");
                            container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg"></i>';
                        });
                    } else {
                        alert("Browser tidak mendukung geolokasi.");
                    }
                };
                return container;
            }
        });
        map.addControl(new LocateControl());


        // --- 4. LOGIC FOR LAYERS ---
        let layers = {
            polygons: L.layerGroup().addTo(map),
            markers: L.layerGroup().addTo(map),
            kelurahans: L.layerGroup().addTo(map) // New Layer for Kelurahan
        };

        const cityListContainer = document.getElementById('city-list');
        const detailPanel = document.getElementById('detail-panel');
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('no-results');

        function getStyle(color) {
            return {
                color: color,
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.05,
                dashArray: '5, 5'
            };
        }

        // --- 5. RENDER UI & MAP ELEMENTS ---
        let allDistricts = []; // Flat list for easier searching

        jakartaData.forEach(city => {
            // A. Draw City Boundary
            const polygon = L.polygon(city.boundary, getStyle(city.color))
                .bindPopup(`<b>${city.name}</b><br>Total Kecamatan: ${city.districts.length}`)
                .addTo(layers.polygons);
            
            polygon.on('click', () => {
                map.flyTo(city.center, 12);
                expandSidebar(city.id);
            });

            // B. Render Sidebar Item
            const cityItem = document.createElement('div');
            cityItem.className = "city-group mb-2 border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm";
            cityItem.id = `group-${city.id}`;
            cityItem.innerHTML = `
                <button onclick="toggleAccordion('${city.id}')" class="w-full px-4 py-3 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-3 shadow-sm" style="background-color: ${city.color}"></div>
                        <span class="font-bold text-sm text-slate-700">${city.name}</span>
                    </div>
                    <i id="icon-${city.id}" class="fa-solid fa-chevron-down text-xs text-gray-400 transition-transform"></i>
                </button>
                <div id="acc-${city.id}" class="accordion-content bg-white">
                    <ul class="text-sm p-2 space-y-1">
                        ${city.districts.map(dist => `
                            <li class="district-item" data-name="${dist.name.toLowerCase()}" data-kels="${dist.kels.join(',').toLowerCase()}">
                                <button onclick="focusDistrict('${city.id}', '${dist.name}')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-50 text-slate-600 hover:text-blue-600 flex justify-between group items-center transition">
                                    <span class="font-medium">${dist.name}</span>
                                    <span class="text-[10px] text-gray-400 group-hover:text-blue-500 bg-gray-50 px-2 py-0.5 rounded border border-gray-100">${dist.kels.length}</span>
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            cityListContainer.appendChild(cityItem);

            // C. Create Markers & Populate Flat List
            city.districts.forEach(dist => {
                allDistricts.push({ cityId: city.id, data: dist });

                const markerHtml = `<div class="pulse-dot" style="background-color: ${city.color}"></div>`;
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: markerHtml,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([dist.lat, dist.lng], { icon: icon })
                    .bindTooltip(dist.name, { 
                        permanent: true, 
                        direction: 'bottom', 
                        offset: [0, 8],
                        className: 'kecamatan-label'
                    });
                
                marker.on('click', () => {
                    showDistrictDetail(city, dist);
                    map.flyTo([dist.lat, dist.lng], 14.5); // Zoom in closer
                });

                dist.marker = marker; 
                layers.markers.addLayer(marker);
            });
        });

        // --- 6. INTERACTION & LOGIC ---

        // Search Functionality
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            let hasResults = false;

            jakartaData.forEach(city => {
                const group = document.getElementById(`group-${city.id}`);
                const listItems = group.querySelectorAll('.district-item');
                let cityHasMatch = false;

                listItems.forEach(item => {
                    const distName = item.getAttribute('data-name');
                    const kels = item.getAttribute('data-kels');
                    
                    if (distName.includes(query) || kels.includes(query)) {
                        item.style.display = 'block';
                        cityHasMatch = true;
                        hasResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (cityHasMatch) {
                    group.style.display = 'block';
                    if (query.length > 0) {
                        document.getElementById(`acc-${city.id}`).classList.add('active');
                        document.getElementById(`icon-${city.id}`).classList.add('rotate-180');
                    }
                } else {
                    group.style.display = 'none';
                }
            });

            if (query.length === 0) {
                jakartaData.forEach(city => {
                    document.getElementById(`group-${city.id}`).style.display = 'block';
                    document.querySelectorAll('.district-item').forEach(i => i.style.display = 'block');
                    document.getElementById(`acc-${city.id}`).classList.remove('active');
                    document.getElementById(`icon-${city.id}`).classList.remove('rotate-180');
                });
                hasResults = true;
            }

            noResults.style.display = hasResults ? 'none' : 'block';
        });

        function toggleAccordion(cityId) {
            jakartaData.forEach(c => {
                if (c.id !== cityId) {
                    document.getElementById(`acc-${c.id}`).classList.remove('active');
                    document.getElementById(`icon-${c.id}`).classList.remove('rotate-180');
                }
            });

            const content = document.getElementById(`acc-${cityId}`);
            const icon = document.getElementById(`icon-${cityId}`);
            content.classList.toggle('active');
            icon.classList.toggle('rotate-180');
        }

        function expandSidebar(cityId) {
             const content = document.getElementById(`acc-${cityId}`);
             if (!content.classList.contains('active')) {
                 toggleAccordion(cityId);
             }
        }

        function focusDistrict(cityId, districtName) {
            const city = jakartaData.find(c => c.id === cityId);
            const dist = city.districts.find(d => d.name === districtName);
            
            if (dist) {
                map.flyTo([dist.lat, dist.lng], 14.5);
                showDistrictDetail(city, dist);
            }
        }

        let currentHighlight = null;

        function showDistrictDetail(city, district) {
            detailPanel.classList.remove('hidden');
            
            // Generate Random Stats for Demo
            const pop = (Math.floor(Math.random() * 80) + 20) + "." + (Math.floor(Math.random() * 9)) + "rb";
            const area = (Math.random() * 8 + 2).toFixed(1);

            document.getElementById('detail-parent').innerText = city.name;
            document.getElementById('detail-parent').style.color = city.color;
            document.getElementById('detail-title').innerText = "Kec. " + district.name;
            document.getElementById('stat-population').innerText = pop;
            document.getElementById('stat-area').innerText = area;
            
            const tagsContainer = document.getElementById('detail-tags');
            tagsContainer.innerHTML = district.kels.map(k => 
                `<span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-1 rounded border border-gray-200 font-medium hover:bg-blue-50 hover:text-blue-600 cursor-default transition">${k}</span>`
            ).join('');

            // Highlight Marker
            if (currentHighlight) {
                currentHighlight.getElement().classList.remove('highlighted');
            }
            const tooltip = district.marker.getTooltip();
            if(tooltip) {
                const el = tooltip.getElement();
                if(el) {
                    el.classList.add('highlighted');
                    currentHighlight = tooltip;
                }
            }

            // Draw Sub-District Boundaries (Simulation)
            drawKelurahanBoundaries(city, district);

            const sb = document.getElementById('sidebar');
            if (sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
            }
        }

        // --- NEW: Generate Kelurahan Boundaries Simulation ---
        function drawKelurahanBoundaries(city, district) {
            layers.kelurahans.clearLayers();
            
            const lat = district.lat;
            const lng = district.lng;
            const kels = district.kels;
            const count = kels.length;
            
            // Grid simulation logic
            const gridSize = Math.ceil(Math.sqrt(count));
            const step = 0.012; // size of each kelurahan block
            
            // Center grid around the district point
            const startLat = lat + (step * gridSize / 2);
            const startLng = lng - (step * gridSize / 2);
            
            kels.forEach((name, index) => {
                const row = Math.floor(index / gridSize);
                const col = index % gridSize;
                
                // Calculate box coordinates
                // Slight randomization to avoid perfect grid look
                const offsetLat = (Math.random() * 0.002) - 0.001;
                const offsetLng = (Math.random() * 0.002) - 0.001;

                const p1 = [startLat - (row * step) + offsetLat, startLng + (col * step) + offsetLng];
                const p2 = [startLat - (row * step) + offsetLat, startLng + ((col + 1) * step) + offsetLng];
                const p3 = [startLat - ((row + 1) * step) + offsetLat, startLng + ((col + 1) * step) + offsetLng];
                const p4 = [startLat - ((row + 1) * step) + offsetLat, startLng + (col * step) + offsetLng];
                
                const poly = [p1, p2, p3, p4];

                L.polygon(poly, {
                    color: 'white',
                    weight: 1.5,
                    fillColor: city.color,
                    fillOpacity: 0.35
                }).bindTooltip(name, {
                    permanent: true, // SEKARANG TRUE: Langsung terlihat
                    direction: 'center',
                    className: 'kelurahan-tooltip' // custom style transparan
                }).on('mouseover', function (e) {
                    this.setStyle({ fillOpacity: 0.6, weight: 2 });
                    // Tooltip sudah visible, tidak perlu openTooltip()
                }).on('mouseout', function (e) {
                    this.setStyle({ fillOpacity: 0.35, weight: 1.5 });
                }).addTo(layers.kelurahans);
            });
        }

        function closeDetail() {
            detailPanel.classList.add('hidden');
            layers.kelurahans.clearLayers(); // Clear polygons when closing
            if (currentHighlight) {
                currentHighlight.getElement().classList.remove('highlighted');
                currentHighlight = null;
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }

        if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

    </script>
</body>
</html>
